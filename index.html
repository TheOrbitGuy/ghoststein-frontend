<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>GHOSTSTEIN Aviator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0d12;
      --panel: #16161f;
      --card: #1e1e2a;
      --border: rgba(255,255,255,0.07);
      --red: #e63946;
      --red2: #ff6b35;
      --green: #2dc653;
      --gold: #f4c430;
      --ghost: #b388ff;
      --text: #ffffff;
      --sub: rgba(255,255,255,0.45);
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow-x:hidden; }

    /* â”€â”€ TOP BAR â”€â”€ */
    .topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    .topbar-logo {
      font-family:'Montserrat',sans-serif; font-weight:900; font-size:20px;
      background:linear-gradient(135deg,#e63946,#ff6b35,#f4c430);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      display:flex; align-items:center; gap:6px;
    }
    .topbar-balance {
      font-family:'Montserrat',sans-serif; font-weight:800; font-size:16px; color:var(--green);
    }
    .topbar-right { display:flex; gap:10px; align-items:center; }
    .icon-btn { background:rgba(255,255,255,0.08); border:none; border-radius:8px; padding:7px 10px; color:var(--sub); cursor:pointer; font-size:16px; }

    /* â”€â”€ HISTORY ROW â”€â”€ */
    .history-row {
      display:flex; gap:6px; padding:8px 12px; overflow-x:auto;
      background:var(--panel); border-bottom:1px solid var(--border);
      scrollbar-width:none;
    }
    .history-row::-webkit-scrollbar { display:none; }
    .hist-badge {
      flex-shrink:0; padding:4px 10px; border-radius:20px;
      font-family:'Montserrat',sans-serif; font-weight:700; font-size:12px;
      white-space:nowrap;
    }
    .hist-badge.low  { background:rgba(99,179,237,0.15); color:#63b3ed; border:1px solid rgba(99,179,237,0.3); }
    .hist-badge.mid  { background:rgba(246,173,85,0.15); color:#f6ad55; border:1px solid rgba(246,173,85,0.3); }
    .hist-badge.high { background:rgba(154,44,250,0.2);  color:#c084fc; border:1px solid rgba(154,44,250,0.4); }

    /* â”€â”€ GAME CANVAS â”€â”€ */
    .game-canvas {
      position:relative; width:100%;
      height:min(56vw, 280px);
      background:#0b0b14; overflow:hidden;
    }

    /* Light rays */
    .rays {
      position:absolute; inset:0; pointer-events:none;
      background: conic-gradient(
        from 200deg at 10% 100%,
        transparent 0deg, rgba(255,255,255,0.018) 3deg, transparent 6deg,
        transparent 9deg, rgba(255,255,255,0.012) 12deg, transparent 15deg,
        transparent 18deg, rgba(255,255,255,0.018) 21deg, transparent 24deg,
        transparent 30deg, rgba(255,255,255,0.010) 33deg, transparent 36deg,
        transparent 42deg, rgba(255,255,255,0.015) 45deg, transparent 48deg,
        transparent 54deg, rgba(255,255,255,0.010) 57deg, transparent 60deg,
        transparent 66deg, rgba(255,255,255,0.018) 69deg, transparent 72deg,
        transparent 90deg
      );
    }

    /* Grid */
    .grid-y {
      position:absolute; inset:0; pointer-events:none;
      display:flex; flex-direction:column; justify-content:space-between; padding:8px 0;
    }
    .grid-line { width:100%; height:1px; background:rgba(255,255,255,0.04); }
    .grid-label { position:absolute; right:6px; font-size:9px; color:rgba(255,255,255,0.2); font-family:'Montserrat',sans-serif; }

    /* Graph SVG */
    .graph-svg { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    /* Ghost emoji watermark */
    .ghost-watermark {
      position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
      font-size:min(20vw, 100px); opacity:0.06; pointer-events:none;
      user-select:none; line-height:1;
    }

    /* Multiplier */
    .mult-wrap {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-55%);
      text-align:center; pointer-events:none; z-index:10;
    }
    .mult-value {
      font-family:'Montserrat',sans-serif; font-weight:900;
      font-size:min(14vw,70px); line-height:1;
      transition:color 0.2s;
    }
    .mult-value.idle   { color:rgba(255,255,255,0.25); }
    .mult-value.flying { color:#fff; text-shadow:0 0 30px rgba(255,255,255,0.4); }
    .mult-value.won    { color:var(--green); text-shadow:0 0 30px rgba(45,198,83,0.6); }
    .mult-value.crashed{ color:var(--red);   text-shadow:0 0 30px rgba(230,57,70,0.6); }

    .mult-label {
      font-size:12px; color:var(--sub); letter-spacing:2px;
      text-transform:uppercase; margin-top:4px;
    }
    .mult-label.countdown { color:var(--gold); font-size:13px; font-weight:600; }
    .mult-label.crashed   { color:var(--red); }
    .mult-label.won       { color:var(--green); }

    /* Plane on canvas */
    .plane-wrap {
      position:absolute; z-index:20;
      transition:none; pointer-events:none;
    }
    .plane-ghost { font-size:16px; position:absolute; top:-20px; left:50%; transform:translateX(-50%); animation:ghost-bob 1s ease-in-out infinite alternate; filter:drop-shadow(0 0 6px rgba(179,136,255,0.9)); }
    @keyframes ghost-bob { from{transform:translateX(-50%) translateY(0)} to{transform:translateX(-50%) translateY(-5px)} }

    .jet {
      width:min(18vw,80px); height:auto;
      filter:drop-shadow(0 0 10px rgba(230,57,70,0.9)) drop-shadow(0 2px 20px rgba(230,57,70,0.5));
    }

    /* Engine fire */
    .fire {
      position:absolute; left:-18px; top:50%; transform:translateY(-50%);
      display:flex; align-items:center;
    }
    .fire-inner {
      width:18px; height:8px; border-radius:0 4px 4px 0;
      background:linear-gradient(to left, #fff, #ffe066, #ff6b35, transparent);
      animation:fire-flicker 0.1s infinite alternate;
    }
    @keyframes fire-flicker {
      from{width:14px;opacity:0.9}
      to{width:22px;opacity:1}
    }

    /* Smoke trail */
    .trail-svg { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:5; }

    /* Crash flash */
    .crash-flash {
      position:absolute; inset:0; background:rgba(230,57,70,0.15);
      pointer-events:none; opacity:0; z-index:25;
      animation:none;
    }
    .crash-flash.show { animation:flash 0.4s ease-out forwards; }
    @keyframes flash { 0%{opacity:1} 100%{opacity:0} }

    /* â”€â”€ BOTTOM PANEL â”€â”€ */
    .bottom { background:var(--bg); padding:10px 12px 20px; }

    /* Quick amounts */
    .quick-amounts {
      display:grid; grid-template-columns:repeat(4,1fr); gap:6px; margin-bottom:10px;
    }
    .qa-btn {
      background:var(--card); border:1px solid var(--border); border-radius:8px;
      padding:8px 0; font-family:'Montserrat',sans-serif; font-weight:700; font-size:13px;
      color:var(--sub); cursor:pointer; transition:all 0.15s; text-align:center;
    }
    .qa-btn:active, .qa-btn.active { background:rgba(230,57,70,0.2); border-color:var(--red); color:#fff; }

    /* Bet row */
    .bet-row {
      display:flex; gap:10px; align-items:center; margin-bottom:10px;
    }
    .bet-ctrl {
      display:flex; align-items:center; background:var(--card);
      border:1px solid var(--border); border-radius:12px; overflow:hidden; flex:1;
    }
    .bet-adj {
      width:42px; height:52px; background:rgba(255,255,255,0.05);
      border:none; color:var(--sub); font-size:22px; cursor:pointer;
      display:flex; align-items:center; justify-content:center; flex-shrink:0;
    }
    .bet-adj:active { background:rgba(255,255,255,0.12); }
    .bet-input {
      flex:1; background:transparent; border:none; outline:none;
      color:#fff; font-family:'Montserrat',sans-serif; font-weight:800;
      font-size:22px; text-align:center;
    }
    .bet-input:disabled { opacity:0.5; }

    /* Main action button */
    .action-btn {
      width:100%; padding:16px; border:none; border-radius:14px;
      font-family:'Montserrat',sans-serif; font-weight:900; font-size:18px;
      color:#fff; cursor:pointer; letter-spacing:0.5px; position:relative;
      overflow:hidden; transition:opacity 0.2s, transform 0.1s;
      touch-action:manipulation;
    }
    .action-btn:active { transform:scale(0.98); }
    .action-btn:disabled { cursor:not-allowed; opacity:0.7; }

    .action-btn.bet-state {
      background:linear-gradient(135deg,#2dc653,#22a844);
      box-shadow:0 4px 24px rgba(45,198,83,0.4);
    }
    .action-btn.cashout-state {
      background:linear-gradient(135deg,#e63946,#c1121f);
      box-shadow:0 4px 24px rgba(230,57,70,0.5);
      animation:cashout-pulse 0.6s ease-in-out infinite alternate;
    }
    @keyframes cashout-pulse {
      from{box-shadow:0 4px 20px rgba(230,57,70,0.4)}
      to{box-shadow:0 4px 40px rgba(230,57,70,0.8),0 0 60px rgba(230,57,70,0.2)}
    }
    .action-btn.countdown-state {
      background:linear-gradient(135deg,#374151,#4b5563);
      box-shadow:none;
    }

    .btn-sub { font-size:12px; font-weight:600; opacity:0.8; display:block; margin-top:2px; letter-spacing:1px; }

    /* Deposit/Withdraw */
    .dw-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
    .dw-btn {
      padding:12px; border:none; border-radius:12px;
      font-family:'Montserrat',sans-serif; font-weight:700; font-size:14px;
      color:#fff; cursor:pointer; transition:all 0.2s;
    }
    .dw-btn.dep { background:rgba(45,198,83,0.2); border:1px solid rgba(45,198,83,0.3); color:var(--green); }
    .dw-btn.wit { background:rgba(154,44,250,0.2); border:1px solid rgba(154,44,250,0.3); color:var(--ghost); }
    .dw-btn:active { transform:scale(0.96); }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(6px); z-index:100; align-items:flex-end; justify-content:center; }
    .modal.open { display:flex; }
    .modal-sheet {
      background:var(--panel); border-radius:20px 20px 0 0;
      padding:24px 20px 36px; width:100%; max-width:500px;
      border-top:1px solid var(--border);
    }
    .modal-title { font-family:'Montserrat',sans-serif; font-weight:800; font-size:18px; margin-bottom:16px; }
    .modal-input {
      width:100%; background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:16px; color:#fff;
      font-family:'Montserrat',sans-serif; font-weight:700; font-size:22px;
      outline:none; margin-bottom:14px;
    }
    .modal-btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .modal-cancel {
      background:rgba(255,255,255,0.08); border:1px solid var(--border);
      border-radius:12px; padding:14px; color:var(--sub);
      font-family:'Montserrat',sans-serif; font-weight:700; font-size:15px; cursor:pointer;
    }
    .modal-ok {
      border:none; border-radius:12px; padding:14px; color:#fff;
      font-family:'Montserrat',sans-serif; font-weight:800; font-size:15px; cursor:pointer;
    }
    .modal-ok.dep { background:linear-gradient(135deg,#2dc653,#22a844); }
    .modal-ok.wit { background:linear-gradient(135deg,#7c3aed,#9333ea); }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-logo">
    ðŸ‘» GHOSTSTEIN
  </div>
  <div class="topbar-balance" id="topbar-balance">0.00</div>
  <div class="topbar-right">
    <button class="icon-btn">â‰¡</button>
  </div>
</div>

<!-- HISTORY ROW -->
<div class="history-row" id="history-row">
  <div class="hist-badge low">1.00x</div>
</div>

<!-- GAME CANVAS -->
<div class="game-canvas" id="game-canvas">
  <div class="rays"></div>

  <!-- Grid lines -->
  <div class="grid-y">
    <div class="grid-line"></div>
    <div class="grid-line"></div>
    <div class="grid-line"></div>
    <div class="grid-line"></div>
    <div class="grid-line"></div>
  </div>

  <!-- Ghost watermark -->
  <div class="ghost-watermark">ðŸ‘»</div>

  <!-- Trail SVG -->
  <svg class="trail-svg" id="trail-svg">
    <defs>
      <linearGradient id="tg" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:rgba(230,57,70,0);"/>
        <stop offset="60%" style="stop-color:rgba(230,57,70,0.6);"/>
        <stop offset="100%" style="stop-color:rgba(255,107,53,0.9);"/>
      </linearGradient>
    </defs>
    <polyline id="trail-path" points="" fill="none" stroke="url(#tg)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    <!-- Filled area under curve -->
    <polygon id="trail-fill" points="" fill="url(#area-grad)" opacity="0.15"/>
    <defs>
      <linearGradient id="area-grad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#e63946;stop-opacity:0.5"/>
        <stop offset="100%" style="stop-color:#e63946;stop-opacity:0"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Graph SVG (axes) -->
  <svg class="graph-svg" id="graph-svg">
    <!-- Y dots -->
    <g id="y-dots"></g>
  </svg>

  <!-- Plane -->
  <div class="plane-wrap" id="plane-wrap" style="left:20px;bottom:20px;">
    <div style="position:relative;display:inline-block;">
      <div class="plane-ghost" id="plane-ghost">ðŸ‘»</div>
      <div style="position:relative;display:inline-flex;align-items:center;">
        <div class="fire"><div class="fire-inner"></div></div>
        <!-- Red Jet SVG -->
        <svg class="jet" id="jet-svg" viewBox="0 0 140 65" xmlns="http://www.w3.org/2000/svg">
          <!-- Shadow/depth -->
          <ellipse cx="70" cy="58" rx="40" ry="4" fill="rgba(0,0,0,0.3)"/>
          <!-- Main fuselage -->
          <path d="M20 32 Q60 18 110 31 Q120 32 130 31 L135 32 L130 33 Q120 34 110 33 Q60 46 20 32 Z" fill="url(#body-grad)"/>
          <defs>
            <linearGradient id="body-grad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#ff3d3d"/>
              <stop offset="50%" style="stop-color:#cc0000"/>
              <stop offset="100%" style="stop-color:#8b0000"/>
            </linearGradient>
          </defs>
          <!-- Cockpit glass -->
          <ellipse cx="105" cy="28" rx="15" ry="7" fill="url(#glass-grad)" stroke="#ff8080" stroke-width="0.5"/>
          <defs>
            <linearGradient id="glass-grad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:rgba(180,220,255,0.8)"/>
              <stop offset="100%" style="stop-color:rgba(80,140,200,0.5)"/>
            </linearGradient>
          </defs>
          <!-- Cockpit glare -->
          <ellipse cx="103" cy="25" rx="6" ry="3" fill="rgba(255,255,255,0.3)"/>
          <!-- Nose cone -->
          <path d="M130 31 L140 32 L130 33 Z" fill="#ff6060"/>
          <!-- Top wing -->
          <path d="M65 28 L30 8 L55 27 Z" fill="url(#wing-grad)"/>
          <!-- Bottom wing -->
          <path d="M65 36 L30 56 L55 37 Z" fill="url(#wing-grad)"/>
          <defs>
            <linearGradient id="wing-grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#880000"/>
              <stop offset="100%" style="stop-color:#cc0000"/>
            </linearGradient>
          </defs>
          <!-- Wing detail lines -->
          <line x1="45" y1="16" x2="58" y2="28" stroke="rgba(255,100,100,0.4)" stroke-width="1"/>
          <line x1="45" y1="48" x2="58" y2="36" stroke="rgba(255,100,100,0.4)" stroke-width="1"/>
          <!-- Tail fin top -->
          <path d="M22 28 L5 12 L28 27 Z" fill="#aa0000"/>
          <!-- Tail fin bottom -->
          <path d="M22 36 L5 52 L28 37 Z" fill="#880000"/>
          <!-- Tail fin vertical -->
          <path d="M18 32 L8 22 L22 30 Z" fill="#bb0000"/>
          <!-- Body stripe -->
          <path d="M55 27 L115 26 L115 28 L55 29 Z" fill="rgba(255,255,255,0.15)"/>
          <!-- Body stripe 2 -->
          <path d="M55 35 L115 36 L115 34 L55 33 Z" fill="rgba(255,255,255,0.08)"/>
          <!-- Engine -->
          <ellipse cx="22" cy="32" rx="9" ry="6" fill="#cc2200"/>
          <!-- Engine inner glow -->
          <ellipse cx="20" cy="32" rx="6" ry="4" fill="#ff6600"/>
          <ellipse cx="18" cy="32" rx="4" ry="3" fill="#ffaa00"/>
          <ellipse cx="16" cy="32" rx="2.5" ry="2" fill="#ffffff"/>
          <!-- Rivets -->
          <circle cx="70" cy="25" r="1" fill="rgba(255,255,255,0.2)"/>
          <circle cx="85" cy="24" r="1" fill="rgba(255,255,255,0.2)"/>
          <circle cx="100" cy="24" r="1" fill="rgba(255,255,255,0.2)"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- Multiplier overlay -->
  <div class="mult-wrap">
    <div class="mult-value idle" id="mult-value">1.00x</div>
    <div class="mult-label" id="mult-label">Waiting for bets...</div>
  </div>

  <!-- Crash flash -->
  <div class="crash-flash" id="crash-flash"></div>
</div>

<!-- BOTTOM PANEL -->
<div class="bottom">

  <!-- Quick amounts -->
  <div class="quick-amounts">
    <button class="qa-btn" onclick="setQuick(100)">100</button>
    <button class="qa-btn" onclick="setQuick(500)">500</button>
    <button class="qa-btn" onclick="setQuick(1000)">1,000</button>
    <button class="qa-btn" onclick="setQuick(5000)">5,000</button>
  </div>

  <!-- Bet control row -->
  <div class="bet-row">
    <div class="bet-ctrl">
      <button class="bet-adj" id="bet-minus" onclick="adjustBet(-50)">âˆ’</button>
      <input class="bet-input" type="number" id="bet-input" value="100" min="1"/>
      <button class="bet-adj" id="bet-plus" onclick="adjustBet(50)">+</button>
    </div>
  </div>

  <!-- Main action button -->
  <button class="action-btn bet-state" id="action-btn" onclick="handleAction()">
    BET
    <span class="btn-sub" id="btn-sub">100 $GHOSTSTEIN</span>
  </button>

  <!-- Deposit / Withdraw -->
  <div class="dw-row">
    <button class="dw-btn dep" onclick="openModal('deposit')">â¬‡ Deposit</button>
    <button class="dw-btn wit" onclick="openModal('withdraw')">â¬† Withdraw</button>
  </div>

</div>

<!-- Deposit Modal -->
<div class="modal" id="deposit-modal">
  <div class="modal-sheet">
    <div class="modal-title">â¬‡ Deposit $GHOSTSTEIN</div>
    <input class="modal-input" type="number" id="dep-input" placeholder="Enter amount"/>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal('deposit')">Cancel</button>
      <button class="modal-ok dep" onclick="doDeposit()">Deposit</button>
    </div>
  </div>
</div>

<!-- Withdraw Modal -->
<div class="modal" id="withdraw-modal">
  <div class="modal-sheet">
    <div class="modal-title">â¬† Withdraw $GHOSTSTEIN</div>
    <input class="modal-input" type="number" id="wit-input" placeholder="Enter amount"/>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal('withdraw')">Cancel</button>
      <button class="modal-ok wit" onclick="doWithdraw()">Withdraw</button>
    </div>
  </div>
</div>

<script>
  const BACKEND = 'https://ghoststein-backend1-production.up.railway.app';

  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let balance    = 0;
  let userId     = 'demo_user';
  let state      = 'waiting';   // waiting | flying | ended | countdown
  let mult       = 1.00;
  let crashAt    = 2.00;
  let gameId     = null;
  let betAmt     = 100;
  let currentBet = 0;
  let animID     = null;
  let cntID      = null;
  let isBusy     = false;
  let startMs    = 0;
  let wobble     = 0;
  let trailPts   = [];  // {x, y} canvas coordinates
  let histData   = [];

  // â”€â”€ CANVAS REF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const canvas = document.getElementById('game-canvas');

  // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.onload = () => {
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      const u = window.Telegram.WebApp.initDataUnsafe?.user;
      if (u) {
        userId = u.id.toString();
      }
    }
    loadBalance();
    updateBtnSub();
    document.getElementById('bet-input').addEventListener('input', () => {
      betAmt = Math.max(1, parseFloat(document.getElementById('bet-input').value) || 1);
      updateBtnSub();
    });
  };

  async function loadBalance() {
    try {
      const r = await fetch(`${BACKEND}/api/user/${userId}`);
      const d = await r.json();
      if (d.success) balance = d.balance;
    } catch { balance = 1000; }
    refreshBalance();
  }

  function refreshBalance() {
    document.getElementById('topbar-balance').textContent = balance.toFixed(2) + ' $G';
  }

  function updateBtnSub() {
    betAmt = Math.max(1, parseFloat(document.getElementById('bet-input').value) || 1);
    document.getElementById('btn-sub').textContent = betAmt.toFixed(2) + ' $GHOSTSTEIN';
  }

  // â”€â”€ BET ADJUST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function adjustBet(delta) {
    if (state !== 'waiting') return;
    const input = document.getElementById('bet-input');
    betAmt = Math.max(1, (parseFloat(input.value) || 0) + delta);
    input.value = betAmt;
    updateBtnSub();
  }

  function setQuick(val) {
    if (state !== 'waiting') return;
    document.getElementById('bet-input').value = val;
    betAmt = val;
    updateBtnSub();
    // highlight
    document.querySelectorAll('.qa-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    setTimeout(() => event.target.classList.remove('active'), 300);
  }

  // â”€â”€ BULLETPROOF BUTTON LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let actionLocked = false;
  let lastActionTime = 0;
  const MIN_GAP = 800; // ms minimum between any two actions

  function canAct() {
    if (actionLocked) return false;
    if (isBusy) return false;
    if (Date.now() - lastActionTime < MIN_GAP) return false;
    return true;
  }
  function lockAction() { actionLocked = true; lastActionTime = Date.now(); }
  function unlockAction() { actionLocked = false; }

  // â”€â”€ MAIN ACTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleAction() {
    // TRIPLE CHECK - must pass ALL three conditions
    if (!canAct()) return;
    if (state === 'waiting') startGame();
    else if (state === 'flying') cashOut();
    // Any other state = do nothing
  }

  // â”€â”€ START GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startGame() {
    // Extra safety - check state one more time
    if (state !== 'waiting') return;

    betAmt = Math.max(1, parseFloat(document.getElementById('bet-input').value) || 1);
    if (betAmt > balance) return alert('Not enough balance!');

    // LOCK IMMEDIATELY before anything else
    lockAction();
    isBusy = true;
    currentBet = betAmt;

    // Kill any existing animation (safety net)
    if (animID) { clearInterval(animID); animID = null; }
    if (cntID)  { clearInterval(cntID);  cntID  = null; }

    try {
      const r = await fetch(`${BACKEND}/api/game/start`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, betAmount: betAmt })
      });
      const d = await r.json();
      if (!d.success) { isBusy = false; return alert(d.error); }
      balance = d.balance;
      gameId  = d.gameId;
      crashAt = Math.min(d.crashPoint || fairCrash(), 20);
    } catch {
      balance -= betAmt;
      gameId   = Date.now().toString();
      crashAt  = fairCrash();
    }

    refreshBalance();
    isBusy = false;
    unlockAction();
    fly();
  }

  function fairCrash() {
    const r = Math.random();
    if (r < 0.35) return 1.00 + Math.random() * 0.70;
    if (r < 0.60) return 1.70 + Math.random() * 0.80;
    if (r < 0.80) return 2.50 + Math.random() * 2.50;
    if (r < 0.93) return 5.00 + Math.random() * 5.00;
    return 10 + Math.random() * 10;
  }

  // â”€â”€ FLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fly() {
    // Kill ANY existing loops first (nuclear option)
    if (animID) { clearInterval(animID); animID = null; }
    if (cntID)  { clearInterval(cntID);  cntID  = null; }

    state   = 'flying';
    mult    = 1.00;
    wobble  = 0;
    trailPts = [];
    startMs = Date.now();

    // Reset SVG
    document.getElementById('trail-path').setAttribute('points','');
    document.getElementById('trail-fill').setAttribute('points','');

    // Reset plane
    const pw = document.getElementById('plane-wrap');
    pw.style.left   = '20px';
    pw.style.bottom = '20px';
    document.getElementById('jet-svg').style.transform = 'rotate(0deg)';
    document.getElementById('jet-svg').style.opacity   = '1';
    document.getElementById('plane-ghost').style.display = 'block';
    document.getElementById('crash-flash').classList.remove('show');

    // UI
    setMult('flying', '1.00x', 'Cash out before it flies away!', '');
    setBtnCashout();
    lockBetControls(true);

    animID = setInterval(tick, 50);
  }

  function tick() {
    const elapsed = (Date.now() - startMs) / 1000;

    // âœ… Smooth, realistic multiplier - max ~20x
    mult = parseFloat((1 + elapsed * elapsed * 0.09).toFixed(2));
    if (mult > 20) mult = 20;

    document.getElementById('mult-value').textContent = mult.toFixed(2) + 'x';

    const cW = canvas.offsetWidth  || 360;
    const cH = canvas.offsetHeight || 220;
    const progress = Math.min((mult - 1) / Math.max(crashAt - 1, 0.1), 1);

    wobble += 0.10;
    const bob = Math.sin(wobble * 2) * (4 + progress * 10);

    // Plane position (bottom-left to upper-right)
    const px = 20 + progress * (cW - 100);
    const py = cH - 30 - progress * (cH - 60) + bob;

    const pw = document.getElementById('plane-wrap');
    pw.style.left   = px + 'px';
    pw.style.bottom = (cH - py - 30) + 'px';

    // Tilt
    const tilt = Math.sin(wobble * 2) * (3 + progress * 7);
    document.getElementById('jet-svg').style.transform = `rotate(${tilt}deg)`;

    // Trail
    trailPts.push({ x: px + 10, y: py + 15 });
    if (trailPts.length > 100) trailPts.shift();

    const pts = trailPts.map(p => `${p.x},${p.y}`).join(' ');
    document.getElementById('trail-path').setAttribute('points', pts);

    // Filled area
    if (trailPts.length > 1) {
      const first = trailPts[0];
      const last  = trailPts[trailPts.length - 1];
      const fillPts = trailPts.map(p => `${p.x},${p.y}`).join(' ')
        + ` ${last.x},${cH} ${first.x},${cH}`;
      document.getElementById('trail-fill').setAttribute('points', fillPts);
    }

    if (mult >= crashAt) doCrash();
  }

  // â”€â”€ CRASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function doCrash() {
    clearInterval(animID); animID = null;
    state = 'ended';
    isBusy = false;
    unlockAction();

    document.getElementById('jet-svg').style.opacity = '0';
    document.getElementById('plane-ghost').style.display = 'none';
    document.getElementById('crash-flash').classList.add('show');

    setMult('crashed', mult.toFixed(2) + 'x', 'ðŸ‘» FLEW AWAY!', 'crashed');
    setBtnCountdown(5);
    addHistory(mult.toFixed(2), false);
    countdown(5);
  }

  // â”€â”€ CASH OUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function cashOut() {
    // Must be flying AND not busy AND lock must work
    if (state !== 'flying') return;
    if (!canAct()) return;

    // STOP ANIMATION FIRST - before anything else!
    clearInterval(animID); animID = null;

    // Lock immediately
    lockAction();
    isBusy = true;
    state  = 'ended';

    const lockedMult = mult;
    const win = parseFloat((currentBet * lockedMult).toFixed(2));

    setMult('won', lockedMult.toFixed(2) + 'x', `ðŸŽ‰ Won ${win.toFixed(2)}!`, 'won');
    setBtnDisabled('âœ… CASHED OUT!');

    try {
      const r = await fetch(`${BACKEND}/api/game/cashout`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, gameId, multiplier: lockedMult })
      });
      const d = await r.json();
      balance = d.success ? d.balance : balance + win;
    } catch { balance += win; }

    refreshBalance();
    addHistory(lockedMult.toFixed(2), true);
    isBusy = false;
    unlockAction();
    countdown(5);
  }

  // â”€â”€ COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function countdown(secs) {
    state = 'countdown';
    setBtnCountdown(secs);
    cntID = setInterval(() => {
      secs--;
      if (secs <= 0) {
        clearInterval(cntID); cntID = null;
        resetRound();
      } else {
        setBtnCountdown(secs);
      }
    }, 1000);
  }

  function resetRound() {
    state = 'waiting';
    mult  = 1.00;
    isBusy = false;
    unlockAction();

    document.getElementById('trail-path').setAttribute('points','');
    document.getElementById('trail-fill').setAttribute('points','');
    const pw = document.getElementById('plane-wrap');
    pw.style.left   = '20px';
    pw.style.bottom = '20px';
    document.getElementById('jet-svg').style.opacity = '1';
    document.getElementById('jet-svg').style.transform = 'rotate(0deg)';
    document.getElementById('plane-ghost').style.display = 'block';
    document.getElementById('crash-flash').classList.remove('show');

    setMult('idle', '1.00x', 'Place your bet!', '');
    setBtnBet();
    lockBetControls(false);
  }

  // â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setMult(cls, val, label, labelCls) {
    const mv = document.getElementById('mult-value');
    const ml = document.getElementById('mult-label');
    mv.className = 'mult-value ' + cls;
    mv.textContent = val;
    ml.className = 'mult-label ' + labelCls;
    ml.textContent = label;
  }

  function setBtnBet() {
    const b = document.getElementById('action-btn');
    b.className = 'action-btn bet-state';
    b.disabled  = false;
    b.childNodes[0].textContent = 'BET ';
    document.getElementById('btn-sub').textContent = betAmt.toFixed(2) + ' $GHOSTSTEIN';
  }

  function setBtnCashout() {
    const b = document.getElementById('action-btn');
    b.className = 'action-btn cashout-state';
    b.disabled  = false;
    b.childNodes[0].textContent = 'CASH OUT ';
    document.getElementById('btn-sub').textContent = (currentBet * mult).toFixed(2) + ' $GHOSTSTEIN';
  }

  function setBtnDisabled(txt) {
    const b = document.getElementById('action-btn');
    b.className = 'action-btn countdown-state';
    b.disabled  = true;
    b.childNodes[0].textContent = txt + ' ';
    document.getElementById('btn-sub').textContent = '';
  }

  function setBtnCountdown(s) {
    const b = document.getElementById('action-btn');
    b.className = 'action-btn countdown-state';
    b.disabled  = true;
    b.childNodes[0].textContent = `â³ Next bet in ${s}s `;
    document.getElementById('btn-sub').textContent = '';
  }

  function lockBetControls(lock) {
    document.getElementById('bet-input').disabled  = lock;
    document.getElementById('bet-minus').disabled  = lock;
    document.getElementById('bet-plus').disabled   = lock;
  }

  // â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addHistory(m, won) {
    histData.unshift({ m, won });
    if (histData.length > 12) histData.pop();

    const row = document.getElementById('history-row');
    row.innerHTML = histData.map(h => {
      const v = parseFloat(h.m);
      let cls = v >= 5 ? 'high' : v >= 2 ? 'mid' : 'low';
      return `<div class="hist-badge ${cls}">${h.m}x</div>`;
    }).join('');
  }

  // â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(t)  { document.getElementById(`${t}-modal`).classList.add('open'); }
  function closeModal(t) { document.getElementById(`${t}-modal`).classList.remove('open'); }

  async function doDeposit() {
    const amt = parseFloat(document.getElementById('dep-input').value);
    if (!amt || amt <= 0) return alert('Enter valid amount!');
    try {
      const r = await fetch(`${BACKEND}/api/deposit`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, amount: amt })
      });
      const d = await r.json();
      balance = d.success ? d.balance : balance + amt;
    } catch { balance += amt; }
    refreshBalance();
    closeModal('deposit');
    document.getElementById('dep-input').value = '';
    alert(`âœ… Deposited ${amt} $GHOSTSTEIN!`);
  }

  async function doWithdraw() {
    const amt = parseFloat(document.getElementById('wit-input').value);
    if (!amt || amt <= 0) return alert('Enter valid amount!');
    if (amt > balance)   return alert('Insufficient balance!');
    try {
      const r = await fetch(`${BACKEND}/api/withdraw`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, amount: amt })
      });
      const d = await r.json();
      balance = d.success ? d.balance : balance - amt;
    } catch { balance -= amt; }
    refreshBalance();
    closeModal('withdraw');
    document.getElementById('wit-input').value = '';
    alert(`âœ… Withdrew ${amt} $GHOSTSTEIN!`);
  }
</script>
</body>
</html>
